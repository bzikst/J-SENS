# J-SENS
Открытый протокол получения данных измерений с датчиков.

### Общее описание

Данный протокол не рассматривает взаимодействие контроллера с физическим сенсором и рассматривает датчик как совокупность устройства измерений и средства преобразования полученной величины в интерпретируемое контроллером значение. Совокупность контроллера и одного или более датчиков назовём устройством.

Устройство на программном уровне реализует веб-сервер, принимающий HTTP-запросы от клиентов. Устройство хранит в себе информацию о датчиках (необходимой информацией является физический адрес/порт датчика) и содержит в себе, по крайней мере один виртуальный датчик — датчик времени. Обмен данными между устройством и клиентом происходит в формате JSON через POST запросы. При старте устройство посылает в сеть широковещательный UDP пакет c кодовым словом формата `{CODENAME}_v{VERSION}_p{PORT}`, сообщая что устройство в сети. 

Общий формат команд для устройства:
```
{
	cmd: <команда: строка>,
	params: <параметры>
}
```

Общий формат ответа от устройства:

```
{
	status: {code: <код ответа (success или fail): строка>, message: <сообщение: строка>},
	<data>: <некоторые данные>	
}
```

### Запросы к устройству и его ответы

Устройство поддерживает команды:
- `get-status` — получить статус устройства, `params = {}`.
- `get-info` — получить информацию об устройстве, `params = {}`.
- `update` — отправить обновления на устройство, `params = {name, data}`, `data` — закодировано base64.
- `start` — подготовка к измерениям, `params = {count, delay, sensors: [addr1, addr2, …]}`, где `count` — количество измерений, delay — ожидаемое время между измерениями, секунды, `addrN` — адрес датчика.
- `get-values` — получить значения с датчиков, `params = {addrs: [addr1, addr2]}`, где `addrN` — адрес датчика.
- `set-ports-setting` — отправить информацию о портах, `params = [{addr: addr1, proccessingMethod: method1}, {addr: addr2, proccessingMethod: method2}, …]`

Устройства отвечает на команды:

```
get-status:
{
	status,
	data: {verification}
}

get-info:
{
	status,
	data: {verification, version, protocol}
}
```

`set-ports-setting` и `start` — возвращают только статус:
```
{status: …}
```

```
get-values: 
{
	status: {code: “success”, message: “OK”},
	data: {sensors: [addr1, addr2, …], values: [row1, row2, row3 …]}
}
```

где `addrN` — адрес датчика (пусть запрошены измерения с k датчиков), 
`rowN = [v1, v2, …, vk]` — массив с данными(строка таблицы), длиной равной k. Каждое число vN соответствует значению снятому с датчика `addrN`.

### Схема работы

1. Включается устройство.
2. Устройство посылает широковещательный UDP пакет с фразой `{CODENAME}_v{VERSION}_p{PORT}` (с определённой частотой).
3. Клиент получает пакет.
4. Если устройство новое, то клиент отправляет на устройство запрос `get-info`.
5. Если устройство уже добавлено, то клиент посылает команду `get-status`.
6. Клиент обновляет у себя информацию об устройствах, не чаще чем каждые 5 секунд.
8. Если устройство недоступно (не отвечает на команду `get-info`), то устройство удаляется.
9. Пользователь запрашивает N измерений с интервалом M секунда.
10. На устройство приходит команда `start`, с соответствующими параметрами.
11. Если ответ положительный, клиент начинает опрашивать (`get-values`) устройство с интервалом M секунд, пока не получит N измерений или пока не произойдет ошибка соединения.

Требования к HTTP ответам от устройства — максимально быстрый отклик, то есть время отклика не должно определяться временем измерения с датчика. Таким образом возможны пустые ответы: 

```
{
	status: {code: “success”, message: “OK”},
	data : {sensors: [addr1, addr2], values: [[]]}
},
```

а также ответы со значениями полученными раннее, но не отправленными node серверу:

```
{
	status: {code: “success”, message: “OK”},
	data : {sensors: [addr1, addr2], values: [[1,61],[80,3]]}
}
```

Запросы и ответы строго используют спецификацию JSON. То есть должно быть: `{“cmd”: “get-sensors”}`. Все элементарные значения, в том числе числа в ответе на запрос `get-values` — передаются как строковый тип и заключаются в кавычки.
